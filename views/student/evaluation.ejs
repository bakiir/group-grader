<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
<%- include('../layouts/header') %>
<div class="container-fluid">
    <div class="row">
        <%- include('../layouts/sidebar') %>
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <div class="d-flex justify-content-between align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">Оценивание команд</h1>
                <a href="/student/dashboard" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Назад
                </a>
            </div>

            <% if (error || req.query.error) { %>
                <div class="alert alert-danger"><%= error || req.query.error %></div>
            <% } %>
            <% if (req.query.success) { %>
                <div class="alert alert-success"><%= req.query.success %></div>
            <% } %>

            <% if (activePeriod) { %>
                <div class="card shadow mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-calendar me-2"></i><%= activePeriod.name %></h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Описание:</strong> <%= activePeriod.description || 'Нет описания' %></p>
                        <p><strong>Период:</strong> <%= new Date(activePeriod.startDate).toLocaleDateString('ru-RU') %> - <%= new Date(activePeriod.endDate).toLocaleDateString('ru-RU') %></p>
                    </div>
                </div>

                <% if (teamsToEvaluate && teamsToEvaluate.length > 0) { %>
                    <div class="accordion" id="teamsAccordion">
                        <% teamsToEvaluate.forEach((team, index) => { %>
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading<%= index %>">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse<%= index %>" aria-expanded="false" aria-controls="collapse<%= index %>">
                                        <strong><%= team.name %></strong> (Группа: <%= team.group.name %>)
                                    </button>
                                </h2>
                                <div id="collapse<%= index %>" class="accordion-collapse collapse" aria-labelledby="heading<%= index %>" data-bs-parent="#teamsAccordion">
                                    <div class="accordion-body">
                                        <h6>Участники:</h6>
                                        <ul class="list-group list-group-flush mb-3">
                                            <% team.members.forEach(member => { %>
                                                <li class="list-group-item"><i class="fas fa-user me-2"></i><%= member.name %></li>
                                            <% }); %>
                                        </ul>
                                        <form method="POST" action="/student/evaluation" class="evaluation-form">
                                            <input type="hidden" name="teamId" value="<%= team._id %>">
                                            <h6>Критерии:</h6>
                                            <% if (criteria && criteria.length > 0) { %>
                                                <table class="table table-sm">
                                                    <tbody>
                                                    <% criteria.forEach(criterion => { %>
                                                        <tr>
                                                            <td><%= criterion.name %></td>
                                                            <td>
                                                                <input type="number"
                                                                       class="form-control form-control-sm"
                                                                       name="criteria[<%= criterion._id %>]"
                                                                       min="0"
                                                                       max="<%= criterion.maxScore %>"
                                                                       step="0.1"
                                                                       placeholder="0"
                                                                       required>
                                                            </td>
                                                            <td>/<%= criterion.maxScore %></td>
                                                            <td class="text-muted">Вес: <%= criterion.weight %>%</td>
                                                        </tr>
                                                    <% }); %>
                                                    </tbody>
                                                </table>
                                            <% } else { %>
                                                <div class="alert alert-warning">Нет критериев</div>
                                            <% } %>
                                            <button type="submit" class="btn btn-primary btn-sm">
                                                <i class="fas fa-star me-2"></i>Оценить
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    </div>
                <% } else { %>
                    <div class="card shadow text-center">
                        <div class="card-body">
                            <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                            <h5>Все команды оценены!</h5>
                            <a href="/student/dashboard" class="btn btn-primary">
                                <i class="fas fa-arrow-left me-2"></i>В кабинет
                            </a>
                        </div>
                    </div>
                <% } %>
            <% } else { %>
                <div class="card shadow text-center">
                    <div class="card-body">
                        <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                        <h5>Нет активного периода</h5>
                        <a href="/student/dashboard" class="btn btn-primary">
                            <i class="fas fa-arrow-left me-2"></i>В кабинет
                        </a>
                    </div>
                </div>
            <% } %>
        </main>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.querySelectorAll('.evaluation-form').forEach(form => {
        form.addEventListener('submit', function(e) {
            const scoreInputs = this.querySelectorAll('input[name*="criteria"]');
            let hasValidScores = true;
            scoreInputs.forEach(input => {
                const value = parseFloat(input.value);
                const max = parseFloat(input.getAttribute('max'));
                if (isNaN(value) || value < 0) {
                    hasValidScores = false;
                    input.classList.add('is-invalid');
                } else if (value > max) {
                    hasValidScores = false;
                    input.classList.add('is-invalid');
                    alert('Оценка не может превышать ${max}');
                } else {
                    input.classList.remove('is-invalid');
                }
            });
            if (!hasValidScores) {
                e.preventDefault();
                alert('Заполните все поля корректно.');
            }
        });
    });
</script>
</body>
</html>